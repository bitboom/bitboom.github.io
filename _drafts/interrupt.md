# 

#   임베디드 시스템, 인터럽트 그리고 익셉션

## 임베디드 시스템의 동작

- CPU, 메모리(주기억장치), 주변장치(I/O장치)로 구성
- 프로그램은 보조기억장치(주변장치)에 저장
- 메모리에 올라와있는 프로그램의 명령어를 CPU가 순차적으로 실행



## 프로그램 수행 중 주변장치의 이벤트 발생

- 인터럽트는, CPU가 프로그램 실행 중, 주변장치(ex. 키보드)의 이벤트를 처리하는 방법

- 인터럽트는 주변장치에서 이벤트가 발생 했을 때 CPU로 처리를 요청하는 방법

  - 주변장치에 출력포트,  CPU에 입력포트 존재
    - CPU의 입력포트는 우선 순위를 두기 위해 IRQ, FIQ 두가지 존재
    - FIQ에선 추가적인 레지스터를 사용하여 CPU 상태의 백업/복원 절차를 생략

- 인터럽트는 두 종류

  - 소프트웨어 인터럽트:  CPU명령어로 제공
  - 하드웨어 인터럽트: 주변장치에서 발생

- 인터럽트가 발생 했을 때 하드웨어가 하는 일

  - 인터럽트 핸들러가 동작할 수 있도록 환경 조성

- 인터럽트가 발생 했을 때 소프트웨어가 하는 일

  - 인터럽트 핸들러(ISR, Interrupt Service Routine)를 통해 인터럽트 처리

    

## 인터럽트 처리 순서

- 인터럽트 발생
- CPU는 프로그램 내 현재 수행중인 명령어까지 처리하고 중단
- CPU가 다음 처리해야할 명령어의 복귀 주소를 저장 
  - IRQ는 LR_irq에 저장
  - FIQ는 LR_fiq에 저장
- CPU상태 백업(CPSR 레지스터 백업)
  - IRQ는 SPSR_irq에 저장
  - FIQ는 SPSR_fiq에 저장
- CPSR 변경
  - 모드 변경, 인터럽트 핸들러가 더 높은 권한의 모드로 수행
    - 주변장치에서 발생한 인터럽트를 처리하기 위해 주변장치의 레지스터 접근
    - 레지스터를 통해 이벤트 확인
    - 디바이스 드라이버
  - 다른 인터럽트 마스킹
- PC를 인터럽트 벡터 테이블(IVT; Interrupt Vector Table)의 엔트리(ex. IRQ_ISR)로 변경
  - IVT는 프로세서 아키텍처(Arm)에서 정해진 구조
  - 특정 인터럽트가 발생하면, IVT의 특정 엔트리를 수행함 (하드웨어)
    - IRQ가 발생했을 때 PC = 0x18로 설정
    - FIQ가 발생했을 때 PC = 0x1C로 설정
  - 인터럽트를 처리하기 위한 ISR을 특정 엔트리에 배치(소프트웨어)
- ISR 호출 (소프트웨어가 하는 일)
  - 스택에 CPU의 일반 목적 레지스터 백업 (하드웨어가 백업해주지 않는 레지스터들에 대해)
  - ISR 실행 (일반 목적 레지스터 사용)
  - 스택에 CPU의 일반 목적 레지스터 복원
  - 인터럽트 발생 전 프로그램 상태로 복원
    - 아래 두 작업이 Atomic하게 일어나야함 => s가 붙은 명령어 subs pc, lr, #r
      - CPU 상태 복원 (SPSR_irq => CPSR) 
      - 복귀 주소를 PC 설정 (LR_irq => PC)



## PC를 목적 레지스터로 설정하는 것은 두가지 경우 뿐

1. 호출함 함수로부터 복귀
2. 익셉션/인터럽트 처리 후 복귀

## CPU 작동모드별 레지스터

- USER 모드(PL0; Privilege Level 0)
  - R0 ~ R12, SP(Stack Pointer), LR(Link Register), PC, CPSR(Current Processor Status Register)
  - 일반 목적 레지스터, 스택 위치, 복귀 주소, 명령어 주소, CPU 현재 상태
- IRQ 모드(PL1)
  - R0 ~ R12, SP_irq, LR_irq, PC, CPSR, SPSR_irq(Saved Processor Status Register)
  - R0 ~ R12는 USER 모드와 공통으로 사용 => 스택에 백업
  - CPSR은 공통으로 사용 => SPSR_irq에 백업
- FIQ 모드(PL1)
  - R0 ~ R7, R8_fiq ~ R12_fiq, SP_fiq, LR_fiq, PC, CPSR, SPSR_fiq
  - R0 ~ R7 공통으로 사용 => 백업 필요?
  - CPSR은 공통으로 사용 => SPSR_fiq에 백업


## CPU 작동모드는 어디에? CPSR

- CPSR 레지스터 값을 통해 모드를 변경하고, 특정 인터럽트를 마스킹
  - 마스킹 = 처리할지 무시할지 정함


## 인터럽트  vs 익셉션
// XXX
